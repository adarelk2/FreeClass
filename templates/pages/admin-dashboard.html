<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>לוח בקרה - מנהל מערכת</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="min-h-screen bg-slate-100">

  <!-- Admin Header -->
  <header class="bg-slate-900 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-sky-600 flex items-center justify-center">
            <i data-lucide="settings" class="w-5 h-5"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">לוח בקרה - מנהל מערכת</h1>
            <p class="text-sm text-slate-400">ניהול כיתות וחיישנים</p>
          </div>
        </div>

        <a href="admin-login.html"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 transition text-sm text-slate-300">
          <i data-lucide="log-out" class="w-4 h-4"></i>
          התנתק
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-6">

    <!-- Tabs -->
    <section class="w-full">
      <div class="bg-white shadow-sm p-1 rounded-xl inline-flex gap-1">
        <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition" data-tab="rooms">ניהול כיתות</button>
        <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition" data-tab="schedule">לוח שעות</button>
        <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition" data-tab="sensors">חיישנים</button>
        <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition" data-tab="buildings">ניהול בניינים</button>
      </div>

      <!-- Rooms -->
      <div class="tab-panel mt-6" id="tab-rooms">
        <div class="bg-white rounded-xl shadow-sm">

          <div class="p-6 border-b border-slate-100 flex items-center justify-between gap-4 flex-wrap">
            <div>
              <h2 class="text-lg font-semibold text-slate-800">ניהול כיתות</h2>
              <p class="text-sm text-slate-500">צפייה והוספה של כיתות לפי בניין</p>
            </div>

            <button id="addRoomBtn"
                    class="h-10 px-4 rounded-md bg-sky-600 text-white hover:bg-sky-700 transition text-sm inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i>
              הוסף כיתה
            </button>
          </div>

          <div class="p-6 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-slate-500 border-b">
                  <th class="text-right py-3">בניין</th>
                  <th class="text-right py-3">קומה</th>
                  <th class="text-right py-3">מספר כיתה</th>
                  <th class="text-right py-3">פעולות</th>
                </tr>
              </thead>
              <tbody id="roomsTbody" class="divide-y"></tbody>
            </table>

            <p id="roomsEmptyHint" class="mt-4 text-sm text-slate-500 hidden">
              עדיין אין כיתות במערכת. הוסף כיתה ראשונה.
            </p>
          </div>
        </div>
      </div>

      <!-- Schedule -->
      <div class="tab-panel mt-6 hidden" id="tab-schedule">
        <div class="bg-white rounded-xl shadow-sm p-6">
          <p class="text-slate-600">לוח שעות שבועי</p>
        </div>
      </div>

      <!-- Sensors -->
      <div class="tab-panel mt-6 hidden" id="tab-sensors">
        <div class="bg-white rounded-xl shadow-sm">

          <div class="p-6 border-b border-slate-100 flex items-center justify-between gap-4 flex-wrap">
            <div>
              <h2 class="text-lg font-semibold text-slate-800">ניהול חיישנים</h2>
              <p class="text-sm text-slate-500">קישור חיישן לכיתה וניהול הטוקנים</p>
            </div>

            <button id="addSensorBtn"
                    class="h-10 px-4 rounded-md bg-sky-600 text-white hover:bg-sky-700 transition text-sm inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i>
              הוסף חיישן
            </button>
          </div>

          <div class="p-6 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-slate-500 border-b">
                  <th class="text-right py-3">ID</th>
                  <th class="text-right py-3">כיתה</th>
                  <th class="text-right py-3">Public_key</th>
                  <th class="text-right py-3">פעולות</th>
                </tr>
              </thead>
              <tbody id="sensorsTbody" class="divide-y"></tbody>
            </table>

            <p id="sensorsEmptyHint" class="mt-4 text-sm text-slate-500 hidden">
              עדיין אין חיישנים במערכת. הוסף חיישן ראשון.
            </p>
          </div>
        </div>
      </div>

      <!-- Buildings -->
      <div class="tab-panel mt-6 hidden" id="tab-buildings">
        <div class="bg-white rounded-xl shadow-sm">
          <div class="p-6 border-b border-slate-100 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-800">ניהול בניינים</h2>
            <button id="addBuildingBtn"
                    class="h-10 px-4 rounded-md bg-sky-600 text-white hover:bg-sky-700 transition text-sm inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i>
              הוסף בניין
            </button>
          </div>

          <div class="p-6 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-slate-500 border-b">
                  <th class="text-right py-3">שם בניין</th>
                  <th class="text-right py-3">מספר כיתות</th>
                  <th class="text-right py-3">קומות</th>
                  <th class="text-right py-3">צבע</th>
                  <th class="text-right py-3">פעולות</th>
                </tr>
              </thead>
              <tbody id="buildingsTbody" class="divide-y"></tbody>
            </table>
          </div>
        </div>
      </div>

    </section>
  </main>

  <!-- Add Building Modal -->
  <div id="buildingModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div id="buildingModalBackdrop" class="absolute inset-0 bg-slate-900/50"></div>

    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-9 h-9 rounded-xl bg-sky-50 flex items-center justify-center">
              <i data-lucide="building-2" class="w-5 h-5 text-sky-700"></i>
            </div>
            <h3 class="text-base font-semibold text-slate-800">הוספת בניין חדש</h3>
          </div>

          <button id="closeBuildingModalBtn"
                  class="h-9 w-9 inline-flex items-center justify-center rounded-lg hover:bg-slate-100 transition"
                  aria-label="סגור">
            <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
          </button>
        </div>

        <form id="buildingForm" class="p-5 space-y-4">
          <div>
            <label for="buildingName" class="block text-sm font-medium text-slate-700 mb-1">שם בניין</label>
            <input id="buildingName" name="name" type="text" required
                   class="w-full h-11 px-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-200"
                   placeholder="למשל: בניין הנדסה" />
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="buildingFloors" class="block text-sm font-medium text-slate-700 mb-1">קומות</label>
              <input id="buildingFloors" name="floors" type="number" min="1" step="1" required
                     class="w-full h-11 px-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-200"
                     value="1" />
            </div>

            <div>
              <label for="buildingColor" class="block text-sm font-medium text-slate-700 mb-1">צבע</label>
              <div class="flex items-center gap-3">
                <input id="buildingColor" name="color" type="color"
                       class="h-11 w-16 rounded-lg border border-slate-200 p-1 bg-white"
                       value="#0ea5e9" />
                <input id="buildingColorText" type="text" readonly
                       class="flex-1 h-11 px-3 rounded-lg border border-slate-200 bg-slate-50 text-slate-700"
                       value="#0ea5e9" />
              </div>
            </div>
          </div>

          <div id="buildingFormError" class="hidden text-sm text-red-600"></div>

          <div class="pt-2 flex items-center justify-end gap-2">
            <button type="button" id="cancelBuildingBtn"
                    class="h-10 px-4 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition">
              ביטול
            </button>
            <button type="submit"
                    class="h-10 px-4 rounded-lg bg-sky-600 text-white hover:bg-sky-700 transition inline-flex items-center gap-2">
              <i data-lucide="check" class="w-4 h-4"></i>
              שמור
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Room Modal -->
  <div id="roomModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div id="roomModalBackdrop" class="absolute inset-0 bg-slate-900/50"></div>

    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-9 h-9 rounded-xl bg-sky-50 flex items-center justify-center">
              <i data-lucide="school" class="w-5 h-5 text-sky-700"></i>
            </div>
            <h3 class="text-base font-semibold text-slate-800">הוספת כיתה חדשה</h3>
          </div>

          <button id="closeRoomModalBtn"
                  class="h-9 w-9 inline-flex items-center justify-center rounded-lg hover:bg-slate-100 transition"
                  aria-label="סגור">
            <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
          </button>
        </div>

        <form id="roomForm" class="p-5 space-y-4">
          <div>
            <label for="roomBuilding" class="block text-sm font-medium text-slate-700 mb-1">בניין</label>
            <select id="roomBuilding" required
                    class="w-full h-11 px-3 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-sky-200"></select>
            <p id="roomNoBuildingsHint" class="mt-2 text-xs text-slate-500 hidden">
              אין בניינים עדיין. הוסף בניין קודם.
            </p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="roomFloor" class="block text-sm font-medium text-slate-700 mb-1">קומה</label>
              <input id="roomFloor" type="number" min="0" step="1" required
                     class="w-full h-11 px-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-200"
                     value="1" />
            </div>

            <div>
              <label for="roomNumber" class="block text-sm font-medium text-slate-700 mb-1">מספר כיתה</label>
              <input id="roomNumber" type="number" min="1" step="1" required
                     class="w-full h-11 px-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-200"
                     value="101" />
            </div>

            <div>
              <label for="roomCategory" class="block text-sm font-medium text-slate-700 mb-1">קטגוריה</label>
              <select id="roomCategory" required
                      class="w-full h-11 px-3 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-sky-200"></select>
              <p id="roomNoCategoryHint" class="mt-2 text-xs text-slate-500 hidden">
                אין קטגוריות עדיין. הוסף קטגוריה קודם.
              </p>
            </div>
          </div>

          <div id="roomFormError" class="hidden text-sm text-red-600"></div>

          <div class="pt-2 flex items-center justify-end gap-2">
            <button type="button" id="cancelRoomBtn"
                    class="h-10 px-4 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition">
              ביטול
            </button>
            <button type="submit"
                    class="h-10 px-4 rounded-lg bg-sky-600 text-white hover:bg-sky-700 transition inline-flex items-center gap-2">
              <i data-lucide="check" class="w-4 h-4"></i>
              שמור
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Sensor Modal -->
  <div id="sensorModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div id="sensorModalBackdrop" class="absolute inset-0 bg-slate-900/50"></div>

    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-9 h-9 rounded-xl bg-sky-50 flex items-center justify-center">
              <i data-lucide="radar" class="w-5 h-5 text-sky-700"></i>
            </div>
            <h3 class="text-base font-semibold text-slate-800">הוספת חיישן חדש</h3>
          </div>

          <button id="closeSensorModalBtn"
                  class="h-9 w-9 inline-flex items-center justify-center rounded-lg hover:bg-slate-100 transition"
                  aria-label="סגור">
            <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
          </button>
        </div>

        <form id="sensorForm" class="p-5 space-y-4">
          <div>
            <label for="sensorRoom" class="block text-sm font-medium text-slate-700 mb-1">בחר כיתה</label>
            <select id="sensorRoom" required
                    class="w-full h-11 px-3 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-sky-200"></select>
            <p id="sensorNoRoomsHint" class="mt-2 text-xs text-slate-500 hidden">
              אין כיתות במערכת. הוסף כיתה לפני יצירת חיישן.
            </p>
          </div>

          <div>
            <label for="sensorToken" class="block text-sm font-medium text-slate-700 mb-1">קוד ציבורי</label>
            <input id="sensorToken" type="text" required
                   class="w-full h-11 px-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-200"
                   placeholder="למשל: token123" />
          </div>

          <div id="sensorFormError" class="hidden text-sm text-red-600"></div>

          <div class="pt-2 flex items-center justify-end gap-2">
            <button type="button" id="cancelSensorBtn"
                    class="h-10 px-4 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition">
              ביטול
            </button>
            <button type="submit"
                    class="h-10 px-4 rounded-lg bg-sky-600 text-white hover:bg-sky-700 transition inline-flex items-center gap-2">
              <i data-lucide="check" class="w-4 h-4"></i>
              שמור
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // CONFIG
    // אם הדף והשרת לא באותו דומיין/פורט, החלף לשורה הזו:
    // const API_URL = 'http://localhost:4000/dashboardadmin';
    // ============================================================
    const API_URL = '/dashboardadmin';

    // -------------------- Initial Data --------------------
    // אם אתה ב-Flask/Jinja2 - זה יעבוד.
    // אם אתה רץ כ-HTML רגיל בלי template engine, תחליף למערכים ידניים.
    let buildings = {{ buildings_server | tojson }};
    let classRoom_categories = {{ classRoom_categories_server | tojson }};
    let sensors = {{ sensors_server | tojson }};
    let rooms = {{ rooms_server | tojson }};

    // -------------------- Helpers --------------------
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function getBuildingNameById(id_building) {
      const b = buildings.find(x => Number(x.id) === Number(id_building));
      return b ? (b.name ?? '') : `בניין #${id_building}`;
    }

    function getRoomById(roomId) {
      return rooms.find(r => Number(r.id) === Number(roomId)) || null;
    }

    function formatRoomLabel(room) {
      const bname = getBuildingNameById(room.id_building);
      const floor = (room.floor ?? '-');
      const num = (room.class_number ?? '-');
      return `${bname} / קומה ${floor} / כיתה ${num}`;
    }

    // -------------------- API helper --------------------
    async function apiCall(method, params) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method, params })
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }

    // -------------------- Tabs --------------------
    function setActiveTab(tab) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');

      document.querySelectorAll('.tab-btn').forEach(b => {
        b.className = `tab-btn px-4 py-2 rounded-lg text-sm font-medium transition ${
          b.dataset.tab === tab ? 'bg-slate-900 text-white' : 'text-slate-700 hover:bg-slate-100'
        }`;
      });
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
    });

    // -------------------- Buildings Table --------------------
    function renderBuildingsTable() {
      const tbody = document.getElementById('buildingsTbody');

      tbody.innerHTML = buildings.map(b => `
        <tr>
          <td class="py-3 font-medium text-slate-800">${escapeHtml(b.name ?? '')}</td>
          <td class="py-3 text-slate-500">${b.totalRooms ?? '-'}</td>
          <td class="py-3 text-slate-500">${b.floors ?? '-'}</td>
          <td class="py-3">
            <div class="inline-flex items-center gap-2">
              <span class="w-4 h-4 rounded-full border border-slate-200" style="background:${b.color ?? '#94a3b8'}"></span>
              <span class="text-slate-500">${b.color ?? '-'}</span>
            </div>
          </td>
          <td class="py-3">
            <button onclick="deleteBuilding(${b.id})"
                    class="px-3 py-1 rounded-md border border-red-200 text-red-600 hover:bg-red-50 text-sm">
              מחק
            </button>
          </td>
        </tr>
      `).join('');

      lucide.createIcons();
    }

    // ===================== DELETE BUILDING (API) =====================
    // IMPORTANT: שנה את שם ה-method וה-params למה שהשרת שלך מצפה!
    // כאן שמתי: method='deleteBuilding', params={ building_id: id }
    async function deleteBuilding(id) {
      if (!confirm('למחוק בניין? זה ימחק גם כיתות וחיישנים קשורים (ב-UI).')) return;

      try {
        const result = await apiCall('deleteBuilding', { building_id: id });
        if (!result.flag) return alert('השרת סירב למחוק את הבניין');

        // Update UI after server success
        buildings = buildings.filter(b => Number(b.id) !== Number(id));
        rooms = rooms.filter(r => Number(r.id_building) !== Number(id));
        sensors = sensors.filter(s => getRoomById(s.room_id) !== null);

        renderBuildingsTable();
        renderRoomsTable();
        renderSensorsTable();
        renderRoomBuildingsSelect();
        renderSensorRoomsSelect();

      } catch (err) {
        console.error(err);
        alert('שגיאת תקשורת עם השרת');
      }
    }

    // -------------------- Rooms Table --------------------
    function renderRoomsTable() {
      const tbody = document.getElementById('roomsTbody');
      const hint = document.getElementById('roomsEmptyHint');

      if (!Array.isArray(rooms) || rooms.length === 0) {
        tbody.innerHTML = '';
        hint.classList.remove('hidden');
        return;
      }

      hint.classList.add('hidden');

      const sorted = [...rooms].sort((a, b) => {
        const ab = Number(a.id_building) - Number(b.id_building);
        if (ab !== 0) return ab;
        const af = Number(a.floor) - Number(b.floor);
        if (af !== 0) return af;
        return Number(a.class_number) - Number(b.class_number);
      });

      tbody.innerHTML = sorted.map(r => `
        <tr>
          <td class="py-3 font-medium text-slate-800">${escapeHtml(getBuildingNameById(r.id_building))}</td>
          <td class="py-3 text-slate-500">${r.floor ?? '-'}</td>
          <td class="py-3 text-slate-500">${r.class_number ?? '-'}</td>
          <td class="py-3">
            <button onclick="deleteRoom(${r.id})"
                    class="px-3 py-1 rounded-md border border-red-200 text-red-600 hover:bg-red-50 text-sm">
              מחק
            </button>
          </td>
        </tr>
      `).join('');

      lucide.createIcons();
    }

    // ===================== DELETE ROOM (API) =====================
    // לפי הדוגמה שלך ב-Postman: method='deleteClassRoom', params={ class_id: id }
    async function deleteRoom(id) {
      if (!confirm('למחוק כיתה?')) return;

      try {
        const result = await apiCall('deleteClassRoom', { class_id: id }); // <-- שנה אם צריך
        if (!result.flag) return alert('השרת סירב למחוק את הכיתה');

        // Update UI after server success
        rooms = rooms.filter(r => Number(r.id) !== Number(id));
        sensors = sensors.filter(s => Number(s.room_id) !== Number(id));

        renderRoomsTable();
        renderSensorsTable();
        renderBuildingsTable();
        renderSensorRoomsSelect();

      } catch (err) {
        console.error(err);
        alert('שגיאת תקשורת עם השרת');
      }
    }

    // -------------------- Sensors Table --------------------
    function renderSensorsTable() {
      const tbody = document.getElementById('sensorsTbody');
      const hint = document.getElementById('sensorsEmptyHint');

      if (!Array.isArray(sensors) || sensors.length === 0) {
        tbody.innerHTML = '';
        hint.classList.remove('hidden');
        return;
      }

      hint.classList.add('hidden');

      const sorted = [...sensors].sort((a, b) => Number(a.id) - Number(b.id));

      tbody.innerHTML = sorted.map(s => {
        const room = getRoomById(s.room_id);
        const roomLabel = room ? formatRoomLabel(room) : `כיתה #${s.room_id}`;
        return `
          <tr>
            <td class="py-3 font-medium text-slate-800">${s.id ?? '-'}</td>
            <td class="py-3 text-slate-700">${escapeHtml(roomLabel)}</td>
            <td class="py-3">
              <code class="px-2 py-1 rounded bg-slate-50 border border-slate-200 text-slate-700">${escapeHtml(s.public_key ?? '')}</code>
            </td>
            <td class="py-3">
              <button onclick="deleteSensor(${s.id})"
                      class="px-3 py-1 rounded-md border border-red-200 text-red-600 hover:bg-red-50 text-sm">
                מחק
              </button>
            </td>
          </tr>
        `;
      }).join('');

      lucide.createIcons();
    }

    // ===================== DELETE SENSOR (API) =====================
    // כאן שמתי: method='deleteSensor', params={ sensor_id: id }
    async function deleteSensor(id) {
      if (!confirm('למחוק חיישן?')) return;

      try {
        const result = await apiCall('deleteSensor', { sensor_id: id }); // <-- שנה אם צריך
        if (!result.flag) return alert('השרת סירב למחוק את החיישן');

        sensors = sensors.filter(s => Number(s.id) !== Number(id));
        renderSensorsTable();

      } catch (err) {
        console.error(err);
        alert('שגיאת תקשורת עם השרת');
      }
    }

    // -------------------- Building Modal --------------------
    const buildingModal = document.getElementById('buildingModal');
    const buildingBackdrop = document.getElementById('buildingModalBackdrop');
    const closeBuildingModalBtn = document.getElementById('closeBuildingModalBtn');
    const cancelBuildingBtn = document.getElementById('cancelBuildingBtn');
    const buildingForm = document.getElementById('buildingForm');
    const buildingErrBox = document.getElementById('buildingFormError');

    const buildingNameInput = document.getElementById('buildingName');
    const buildingFloorsInput = document.getElementById('buildingFloors');
    const buildingColorInput = document.getElementById('buildingColor');
    const buildingColorText = document.getElementById('buildingColorText');

    function openBuildingModal() {
      buildingErrBox.classList.add('hidden');
      buildingErrBox.textContent = '';

      buildingNameInput.value = '';
      buildingFloorsInput.value = '1';
      buildingColorInput.value = '#0ea5e9';
      buildingColorText.value = '#0ea5e9';

      buildingModal.classList.remove('hidden');
      buildingModal.setAttribute('aria-hidden', 'false');

      setTimeout(() => buildingNameInput.focus(), 0);
      lucide.createIcons();
    }

    function closeBuildingModal() {
      buildingModal.classList.add('hidden');
      buildingModal.setAttribute('aria-hidden', 'true');
      buildingErrBox.classList.add('hidden');
      buildingErrBox.textContent = '';
    }

    document.getElementById('addBuildingBtn').addEventListener('click', openBuildingModal);
    buildingBackdrop.addEventListener('click', closeBuildingModal);
    closeBuildingModalBtn.addEventListener('click', closeBuildingModal);
    cancelBuildingBtn.addEventListener('click', closeBuildingModal);

    buildingColorInput.addEventListener('input', () => {
      buildingColorText.value = buildingColorInput.value;
    });

    function showBuildingFormError(msg) {
      buildingErrBox.textContent = msg;
      buildingErrBox.classList.remove('hidden');
    }

    buildingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      buildingErrBox.classList.add('hidden');
      buildingErrBox.textContent = '';

      const name = buildingNameInput.value.trim();
      const floors = parseInt(buildingFloorsInput.value, 10);
      const color = buildingColorInput.value;

      if (!name) return showBuildingFormError('חובה להזין שם בניין');
      if (!Number.isInteger(floors) || floors < 1)
        return showBuildingFormError('מספר קומות חייב להיות מספר שלם >= 1');

      try {
        const result = await apiCall('createNewBuilding', { building_name: name, color, floors });
        if (!result.flag) return showBuildingFormError('השרת סירב ליצור את הבניין');

        buildings.push({ id: result.id, name, floors, color, totalRooms: 0 });
        renderBuildingsTable();
        renderRoomBuildingsSelect();
        closeBuildingModal();

      } catch (err) {
        console.error(err);
        showBuildingFormError('שגיאת תקשורת עם השרת');
      }
    });

    // -------------------- Room Modal --------------------
    const roomModal = document.getElementById('roomModal');
    const roomBackdrop = document.getElementById('roomModalBackdrop');
    const closeRoomModalBtn = document.getElementById('closeRoomModalBtn');
    const cancelRoomBtn = document.getElementById('cancelRoomBtn');
    const roomForm = document.getElementById('roomForm');
    const roomErrBox = document.getElementById('roomFormError');

    const roomBuildingSelect = document.getElementById('roomBuilding');
    const roomNoBuildingsHint = document.getElementById('roomNoBuildingsHint');
    const roomCategorySelect = document.getElementById('roomCategory');
    const roomNoCategorySelect = document.getElementById('roomNoCategoryHint');
    const roomFloorInput = document.getElementById('roomFloor');
    const roomNumberInput = document.getElementById('roomNumber');

    function renderRoomBuildingsSelect() {
      const hasBuildings = Array.isArray(buildings) && buildings.length > 0;
      roomNoBuildingsHint.classList.toggle('hidden', hasBuildings);

      roomBuildingSelect.innerHTML = (hasBuildings ? buildings : []).map(b => `
        <option value="${b.id}">${escapeHtml(b.name ?? '')}</option>
      `).join('');

      roomBuildingSelect.disabled = !hasBuildings;
    }

    function renderRoomCategorySelect() {
      const hasCategories = Array.isArray(classRoom_categories) && classRoom_categories.length > 0;
      roomNoCategorySelect.classList.toggle('hidden', hasCategories);

      roomCategorySelect.innerHTML = `<option value="0">יש לבחור קטגוריה</option>` +
        (hasCategories ? classRoom_categories : []).map(c => `
          <option value="${c.id}">${escapeHtml(c.name ?? '')}</option>
        `).join('');

      roomCategorySelect.disabled = !hasCategories;
    }

    function openRoomModal() {
      roomErrBox.classList.add('hidden');
      roomErrBox.textContent = '';

      renderRoomBuildingsSelect();
      renderRoomCategorySelect();

      roomFloorInput.value = '1';
      roomNumberInput.value = '101';

      roomModal.classList.remove('hidden');
      roomModal.setAttribute('aria-hidden', 'false');

      setTimeout(() => {
        if (!roomBuildingSelect.disabled) roomBuildingSelect.focus();
        else roomFloorInput.focus();
      }, 0);

      lucide.createIcons();
    }

    function closeRoomModal() {
      roomModal.classList.add('hidden');
      roomModal.setAttribute('aria-hidden', 'true');
      roomErrBox.classList.add('hidden');
      roomErrBox.textContent = '';
    }

    document.getElementById('addRoomBtn').addEventListener('click', openRoomModal);
    roomBackdrop.addEventListener('click', closeRoomModal);
    closeRoomModalBtn.addEventListener('click', closeRoomModal);
    cancelRoomBtn.addEventListener('click', closeRoomModal);

    function showRoomFormError(msg) {
      roomErrBox.textContent = msg;
      roomErrBox.classList.remove('hidden');
    }

    roomForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      roomErrBox.classList.add('hidden');
      roomErrBox.textContent = '';

      if (roomBuildingSelect.disabled) return showRoomFormError('אין בניינים. קודם הוסף בניין.');

      const building_id = parseInt(roomBuildingSelect.value, 10);
      const roomCategory_id = parseInt(roomCategorySelect.value, 10);
      const floor = parseInt(roomFloorInput.value, 10);
      const class_number = parseInt(roomNumberInput.value, 10);

      if (!Number.isInteger(building_id) || building_id < 1) return showRoomFormError('בחר בניין תקין');
      if (!Number.isInteger(roomCategory_id) || roomCategory_id < 1) return showRoomFormError('יש לבחור קטגוריה');
      if (!Number.isInteger(floor)) return showRoomFormError('קומה חייבת להיות מספר שלם');
      if (!Number.isInteger(class_number) || class_number < 1) return showRoomFormError('מספר כיתה חייב להיות מספר שלם >= 1');

      try {
        const result = await apiCall('createNewRoom', { building_id, floor, class_number, category_id: roomCategory_id });
        if (!result.flag) return showRoomFormError('השרת סירב ליצור את הכיתה');

        rooms.push({ id: result.id, id_building: building_id, floor, class_number });
        renderRoomsTable();
        renderSensorRoomsSelect();
        closeRoomModal();

      } catch (err) {
        console.error(err);
        showRoomFormError('שגיאת תקשורת עם השרת');
      }
    });

    // -------------------- Sensor Modal --------------------
    const sensorModal = document.getElementById('sensorModal');
    const sensorBackdrop = document.getElementById('sensorModalBackdrop');
    const closeSensorModalBtn = document.getElementById('closeSensorModalBtn');
    const cancelSensorBtn = document.getElementById('cancelSensorBtn');
    const sensorForm = document.getElementById('sensorForm');
    const sensorErrBox = document.getElementById('sensorFormError');

    const sensorRoomSelect = document.getElementById('sensorRoom');
    const sensorNoRoomsHint = document.getElementById('sensorNoRoomsHint');
    const sensorTokenInput = document.getElementById('sensorToken');

    function renderSensorRoomsSelect() {
      const hasRooms = Array.isArray(rooms) && rooms.length > 0;
      sensorNoRoomsHint.classList.toggle('hidden', hasRooms);

      const sortedRooms = hasRooms ? [...rooms].sort((a,b) => {
        const ab = Number(a.id_building) - Number(b.id_building);
        if (ab !== 0) return ab;
        const af = Number(a.floor) - Number(b.floor);
        if (af !== 0) return af;
        return Number(a.class_number) - Number(b.class_number);
      }) : [];

      sensorRoomSelect.innerHTML = sortedRooms.map(r => `
        <option value="${r.id}">${escapeHtml(formatRoomLabel(r))}</option>
      `).join('');

      sensorRoomSelect.disabled = !hasRooms;
    }

    function openSensorModal() {
      sensorErrBox.classList.add('hidden');
      sensorErrBox.textContent = '';

      renderSensorRoomsSelect();
      sensorTokenInput.value = '';

      sensorModal.classList.remove('hidden');
      sensorModal.setAttribute('aria-hidden', 'false');

      setTimeout(() => {
        if (!sensorRoomSelect.disabled) sensorRoomSelect.focus();
        else sensorTokenInput.focus();
      }, 0);

      lucide.createIcons();
    }

    function closeSensorModal() {
      sensorModal.classList.add('hidden');
      sensorModal.setAttribute('aria-hidden', 'true');
      sensorErrBox.classList.add('hidden');
      sensorErrBox.textContent = '';
    }

    document.getElementById('addSensorBtn').addEventListener('click', openSensorModal);
    sensorBackdrop.addEventListener('click', closeSensorModal);
    closeSensorModalBtn.addEventListener('click', closeSensorModal);
    cancelSensorBtn.addEventListener('click', closeSensorModal);

    function showSensorFormError(msg) {
      sensorErrBox.textContent = msg;
      sensorErrBox.classList.remove('hidden');
    }

    sensorForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      sensorErrBox.classList.add('hidden');
      sensorErrBox.textContent = '';

      if (sensorRoomSelect.disabled) return showSensorFormError('אין כיתות במערכת. קודם הוסף כיתה.');

      const room_id = parseInt(sensorRoomSelect.value, 10);
      const token = (sensorTokenInput.value || '').trim();

      if (!Number.isInteger(room_id) || room_id < 1) return showSensorFormError('בחר כיתה תקינה');
      if (!token) return showSensorFormError('חובה להזין public_key');

      const tokenExists = sensors.some(s => String(s.token) === token);
      if (tokenExists) return showSensorFormError('public_key כבר קיים במערכת');

      try {
        const result = await apiCall('createNewSensor', { room_id, "public_key":token });
        if (!result.flag) return showSensorFormError('השרת סירב ליצור את החיישן');
       
        Swal.fire({
          icon: "success",
          title: "יש לשמור את הקוד הפרטי להמשך",
          text: result.msg.private_key
        });

        sensors.push({ id: result.id, room_id, token });
        renderSensorsTable();
        closeSensorModal();

      } catch (err) {
        console.error(err);
        showSensorFormError('שגיאת תקשורת עם השרת');
      }
    });

    // -------------------- Global keys --------------------
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!buildingModal.classList.contains('hidden')) closeBuildingModal();
        if (!roomModal.classList.contains('hidden')) closeRoomModal();
        if (!sensorModal.classList.contains('hidden')) closeSensorModal();
      }
    });

    // -------------------- Init --------------------
    renderBuildingsTable();
    renderRoomsTable();
    renderSensorsTable();
    setActiveTab('rooms');
    renderRoomBuildingsSelect();
    renderSensorRoomsSelect();
    lucide.createIcons();
  </script>

</body>
</html>
