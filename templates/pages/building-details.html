<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>פרטי בניין</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-sky-50">

<!-- Header -->
<header class="bg-white border-b sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
    <a href="dashboard.html"
       class="w-10 h-10 rounded-md hover:bg-slate-100 flex items-center justify-center">
      <i data-lucide="arrow-right"></i>
    </a>
    <h1 id="buildingTitle" class="text-xl font-bold"></h1>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

  <!-- Hero -->
  <section class="bg-white rounded-xl shadow overflow-hidden">
    <div id="heroBg" class="h-32 relative">
      <div class="absolute inset-0 bg-black/10"></div>
      <div class="absolute bottom-4 right-6 text-white">
        <h2 id="heroName" class="text-2xl font-bold"></h2>
      </div>
    </div>

    <div class="p-6 flex justify-between flex-wrap gap-3">
      <div class="text-slate-600">
        סה״כ קומות: <span id="floorsCount"></span>
      </div>
      <div class="text-2xl font-bold text-sky-600">
        <span id="totalAvailable">0</span> כיתות פנויות
      </div>
    </div>
  </section>

  <!-- Floor selector -->
  <section class="bg-white rounded-xl shadow">
    <div class="px-6 pt-6 flex justify-between">
      <h3 class="text-lg font-semibold">בחר קומה</h3>
      <div class="text-sm text-slate-500">
        <span id="availableCount">0</span> /
        <span id="totalOnFloor">0</span> פנויות
      </div>
    </div>

    <div id="floorButtons" class="px-6 py-4 flex gap-2 overflow-x-auto"></div>
  </section>

  <!-- Rooms -->
  <section class="bg-white rounded-xl shadow">
    <div class="px-6 pt-6">
      <h3 class="text-lg font-semibold">
        כיתות בקומה <span id="selectedFloorLabel"></span>
      </h3>
    </div>

    <div id="spacesList" class="px-6 pb-6 space-y-3"></div>
  </section>

</main>

<script>
  // =============================
  // BACKEND DATA
  // =============================
  const building = {{ building | tojson }};

  // =============================
  // NORMALIZE ROOMS -> FLOORS
  // =============================
  const floorsMap = {};

  building.rooms.forEach(room => {
    if (!floorsMap[room.floor]) {
      floorsMap[room.floor] = [];
    }

    floorsMap[room.floor].push({
      id: room.id,
      name: `כיתה ${room.class_number}`,
      isAvailable: room.is_available === true
    });
  });

  const floors = Object.keys(floorsMap)
    .map(n => ({
      number: Number(n),
      rooms: floorsMap[n]
    }))
    .sort((a, b) => a.number - b.number);

  // =============================
  // STATE
  // =============================
  let selectedFloor = floors[0]?.number || 1;

  // =============================
  // ELEMENTS
  // =============================
  const buildingTitle = document.getElementById('buildingTitle');
  const heroName = document.getElementById('heroName');
  const heroBg = document.getElementById('heroBg');
  const floorsCount = document.getElementById('floorsCount');
  const totalAvailableEl = document.getElementById('totalAvailable');

  const floorButtons = document.getElementById('floorButtons');
  const availableCountEl = document.getElementById('availableCount');
  const totalOnFloorEl = document.getElementById('totalOnFloor');
  const selectedFloorLabel = document.getElementById('selectedFloorLabel');
  const spacesList = document.getElementById('spacesList');

  // =============================
  // HEADER INIT
  // =============================
  buildingTitle.textContent = building.building_name;
  heroName.textContent = building.building_name;
  floorsCount.textContent = building.floors;
  heroBg.style.background = building.color || '#1D5875';

  const totalAvailable =
    building.rooms.filter(r => r.is_available === true).length;
  totalAvailableEl.textContent = totalAvailable;

  // =============================
  // FLOOR BUTTONS
  // =============================
  function renderFloorButtons() {
    floorButtons.innerHTML = floors.map(f => {
      const available = f.rooms.filter(r => r.isAvailable).length;
      const active = f.number === selectedFloor;

      return `
        <button data-floor="${f.number}"
          class="px-4 py-2 rounded-md border text-sm transition
          ${active ? 'bg-sky-600 text-white border-sky-600'
                   : 'bg-white border-slate-200 hover:bg-slate-50'}">
          קומה ${f.number}
          <div class="text-xs opacity-80">${available} פנויות</div>
        </button>
      `;
    }).join('');

    lucide.createIcons();
  }

  // =============================
  // ROOMS LIST
  // =============================
  function renderRooms() {
    const floor = floors.find(f => f.number === selectedFloor);
    if (!floor) return;

    selectedFloorLabel.textContent = selectedFloor;
    totalOnFloorEl.textContent = floor.rooms.length;

    const available = floor.rooms.filter(r => r.isAvailable).length;
    availableCountEl.textContent = available;

    spacesList.innerHTML = floor.rooms.map(r => `
      <div class="flex justify-between items-center p-4 rounded-xl border-r-4
        ${r.isAvailable ? 'bg-emerald-50 border-emerald-500'
                        : 'bg-red-50 border-red-500'}">
        <div class="flex items-center gap-3">
          <i data-lucide="${r.isAvailable ? 'check-circle' : 'x-circle'}"
             class="${r.isAvailable ? 'text-emerald-600' : 'text-red-600'}"></i>
          <span class="font-semibold">${r.name}</span>
        </div>
        <span class="font-bold
          ${r.isAvailable ? 'text-emerald-700' : 'text-red-700'}">
          ${r.isAvailable ? 'פנוי' : 'תפוס'}
        </span>
      </div>
    `).join('');

    lucide.createIcons();
  }

  // =============================
  // EVENTS
  // =============================
  floorButtons.addEventListener('click', e => {
    const btn = e.target.closest('[data-floor]');
    if (!btn) return;
    selectedFloor = Number(btn.dataset.floor);
    renderFloorButtons();
    renderRooms();
  });

  // =============================
  // BOOT
  // =============================
  renderFloorButtons();
  renderRooms();
  lucide.createIcons();
</script>

</body>
</html>
